---
tags:
  - MALWARE-ANALISYS
  - LetsDefend
---
# Introdução à Análise de Malware
Como analista de SOC, muitas vezes você analisa arquivos suspeitos em sua rotina diária de trabalho. Com o treinamento de fundamentos de malware, as informações básicas necessárias serão aprendidas através da introdução do assunto da análise de malware.

Neste treinamento;

- Definição de malware,
- Tipos de malware,
- Abordagens de análise de malware,
- Como analisar arquivos suspeitos simplesmente

---
# Tipos de malware
Embora os nomes dos servidores de comando e controle e os métodos que eles usam variem, os propósitos do software malicioso estão dentro de determinadas *categorias*. Desta forma, você pode informar a outra pessoa sobre o que o malware está fazendo simplesmente dizendo a categoria do malware.

Por exemplo, se você disser que o software que você está examinando é um keylogger, todos saberão que este é um *software que grava e reproduz as teclas pressionadas no teclado*. 

Como mencionamos, o software malicioso é dividido em tipos de acordo com suas funções/propósitos/caracteres. Depois de analisar o malware, você irá combiná-lo com um dos seguintes tipos. 

- **Backdoor:** Deixando um backdoor no dispositivo onde o malware está instalado, ele permite que o invasor acesse o sistema através deste backdoor. Por exemplo, ao abrir uma porta de rede conectada ao shell, ela permite que o invasor se conecte ao sistema por meio dessa porta.
- **Adware:** muitas vezes vem com software baixado, fazendo com que anúncios indesejados sejam exibidos no dispositivo. Embora nem todos os adwares sejam prejudiciais, alguns alteram o mecanismo de pesquisa padrão.
- **Ransomware:** É um tipo de malware que tem estado na agenda mundial nos últimos anos. Ele exige resgate de pessoas criptografando e exfiltrando todos os arquivos no dispositivo.
- **Vírus:** É um dos primeiros tipos de malware vistos na natureza. Então, vemos que, na vida diária, é frequentemente chamado de vírus em vez do termo malware. Os vírus têm uma característica auto-replicada. Ele fornece persistência ao infectar outros arquivos no dispositivo.
- **Verme:** Como esse tipo de malware se espalha de dispositivos infectados para outros dispositivos, ele é chamado de worm. O WannaCry, um malware para worm que explora a vulnerabilidade MS17-010, causou pânico em todo o mundo.
- **Rootkit:** É um tipo de malware que se disfarça, fornecendo acesso a um alto nível de autoridade no dispositivo.
- **RAT (Trojan de acesso remoto):** É um tipo de malware que fornece controle total sobre o dispositivo para o agente de ameaças.
- **Um** tipo de malware que tem como alvo aplicativos bancários e faz com que o dinheiro seja roubado da vítima.
- **Keylogger:** Um tipo de malware que registra as chaves empurrou as chaves e envia essas informações para o invasor.

Um malware pode conter mais de um recurso, portanto, um malware pode pertencer a mais de um tipo. Por exemplo, o malware WannaCry inclui recursos de malware worm e ransomware.

---
# O que um analista de malware deve saber
A análise de malware é um assunto que pode parecer fácil do exterior, mas, em essência, requer experiência em muitos aspectos. Embora a análise de malware seja um campo separado por si só, alguns analistas SOC de nível 3 (Consetistas de assunto) concentram suas carreiras apenas na análise de malware. Embora a análise de malware seja um campo separado, muitas vezes é usada por analistas de segurança em suas rotinas diárias de trabalho.

A fim de ser capaz de analisar software malicioso corretamente e com sucesso, é necessário ter o básico em muitos assuntos. Vamos dar uma olhada nesses tópicos.
## Fundamentos do Sistema Operacional e Arquitetura
Como o malware é executado em sistemas operacionais, os analistas de malware devem ter uma sólida compreensão e conhecimento dos sistemas operacionais.

![](https://letsdefend.io/blog/wp-content/uploads/2022/04/monolithic_os_kernel.gif)

O malware muitas vezes tira proveito dos **recursos oferecidos pelo sistema operacional**, aumentando seus privilégios, fazendo descobertas e *garantindo persistência*. Para dar um exemplo em sistemas operacionais Windows, o software malicioso usa os recursos do sistema operacional, como Agendador de Tarefas, Serviços, Registro para garantir a persistência.

Além dos recursos do sistema operacional, API, Syscalls, Memory Architecture e problemas de nível inferior também são importantes para a análise bem-sucedida de malware. Vamos nos concentrar nesses tópicos mais no treinamento "Análise de Malware Sático".
## Idioma e Programação de Montagem 
Se você já desenvolveu software antes, você já se perguntou o que acontece quando você **compila as linguagens de programação** que você escreve?Ou você já se perguntou como os processadores executam várias linguagens de programação quando há muitas linguagens de programação.compiladores traduzem os códigos que você escreve em 0s e 1s que o processador pode entender.Quando você inicia um programa, esses 0s e 1s são enviados para o processador sobre a memória a ser executada.A linguagem de programação de nível mais baixo que você pode ver é Assembly se não considerarmos 0s e 1s.Quando você compila um programa escrito em C, ele é traduzido primeiro para o idioma Assembly e depois para 0s e 1s.O software que traduz os códigos de máquina para o idioma Assembly é chamado de ‘‘Disassembler‘‘.
## Protocolos e Fundamentos da Rede
O malware geralmente exibe **atividade de rede** para *sequestrar* *informações*, conectar-se a um servidor de comando e controle ou baixar segundas cargas úteis. Entender esses tráfegos de rede ao analisar malware é extremamente importante para entendermos o propósito do malware.

Por esse motivo, os analistas de malware devem ter conhecimento básico da rede.
## Criptografia
![](https://letsdefend.io/blog/wp-content/uploads/2022/05/image.png)

Muitas tecnologias fazem uso de criptografia para fornecer segurança. Também é usado por invasores para fins como complicar, prevenir a detecção e prevenir o acesso.

---
# Qual abordagem você deve escolher ao analisar Malware?

Se você trabalha no campo defensivo, a análise de malware se torna parte do seu trabalho.

Neste artigo, vamos discutir com quais abordagens você pode analisar malware e as vantagens / desvantagens dessas abordagens entre si.

Existem duas abordagens diferentes para analisar malware.

1. Análise estática
2. Análise dinâmica

## Análise estática
É a abordagem de analisar softwares maliciosos por métodos de engenharia reversa sem elihá-los.

Geralmente, por descompilar / desmontar o malware, cada etapa que o malware executar será analisada, portanto, o comportamento / capacidade do malware pode ser analisado.

![debugger](https://letsdefend.io/blog/wp-content/uploads/2020/11/linux-1024x696.gif)

https://www.hex-rays.com/products/ida/news/6_0/

Seu dispositivo não será infectado, pois você não executa software malicioso em análise estática. (No entanto, não recomendamos realizar análises estáticas em seu dispositivo host, será mais adequado fazer sua análise em um sistema operacional virtual.)

As informações examinadas durante a análise estática são as seguintes.

1. P.E. (em inglês) (Portátil Executável) Cabeçalhos
2. O DLL importado
3. O DLL exportado
4. Strings em binário
5. Instruções da CPU

## Análise dinâmica
É a abordagem que examina o comportamento de software malicioso no sistema executando-o.

Na análise dinâmica, aplicativos que podem examinar eventos de registro, arquivo, rede e processo são instalados no sistema e seu comportamento é examinado executando software malicioso.

Ao fazer uma análise dinâmica, você deve examinar cuidadosamente os seguintes eventos.

1. Conexões de rede
2. Eventos de Arquivo
3. Eventos de Processo
4. Eventos de Registro

![process monitor tool](https://letsdefend.io/blog/wp-content/uploads/2020/11/procmon-app.png)

## Análise Estática vs Análise Dinâmica
Qual abordagem usar ao analisar malware depende das circunstâncias atuais. Nos casos em que você deseja obter resultados rápidos, você pode escolher a análise dinâmica, mas não podemos dizer que a análise está completa sem fazer análise estática e dinâmica.

Também deve-se notar que o uso de apenas uma abordagem pode não ser suficiente para analisar malware. Usar as duas abordagens juntos irá levá-lo à vitória!

![process monitor tool](https://letsdefend.io/blog/wp-content/uploads/2022/05/static-analysis-vs-dynamic-analysis.png)

Como resultado, não podemos dizer que uma abordagem é melhor que outra. Cada um tem uma vantagem sobre o outro em diferentes condições.

Se você trabalha como analista SOC de Nível 1-2, geralmente pode agir obtendo rapidamente o endereço c2 com a ajuda de análise dinâmica.

---
# Exemplo de Análise Dinâmica Usando AnyRun
Você pode aproveitar os serviços / produtos da sandbox para analisar rapidamente o malware.

[AnyRun](https://any.run/) é uma sandbox interativa que você pode usar quando você deseja analisar malware rapidamente.

AnyRun tem opções para uso pago ou gratuito. Se você quiser aproveitá-lo gratuitamente, toda a sua análise é visível para outras pessoas, portanto, não recomendamos que você faça o upload de arquivos que possam conter dados pessoais para o AnyRun. Além disso, o plano gratuito tem restrições, como o tempo de uso.

Como podemos usar o AnyRun para nossa análise de malware, que tipo de saídas podemos obter, vamos examiná-lo juntos.

Vamos baixar o malware com hash **80b51e872031a2befeb9a0a1a16fc480** para analisar via [AbuseCH (Clique aqui para baixar](https://bazaar.abuse.ch/sample/708e198608b5b463224c3fb77fcf708b845d0c7b5dbc6e9cab9e185c489be089/)).

Temos que clicar no + botão " +" (Nova Tarefa) no menu esquerdo para carregar o malware que baixamos.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-22.48.58.png)

Vamos carregar o arquivo que queremos analisar na tela que abre com a ajuda do botão "Escolher um arquivo". Depois que o arquivo é carregado, podemos determinar os parâmetros, como qual sistema operacional queremos executar o malware e 32/64 bit do sistema operacional para usar. Depois de determinar estes, abrimos nossa caixa de areia com a ajuda do botão **"Corra"** na parte inferior direita da tela que se abre.

Quando nossa máquina está ligado, executamos o software malicioso que carregamos para ver suas atividades.

Alguns malwares permanecem inativos por um determinado período de tempo antes de realizar suas atividades maliciosas, dificultando a análise. Vamos dar tempo para o malware realizar suas atividades, durante esse período, vamos examinar a interface AnyRun juntos.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-22.58.53-scaled.jpg)

1. A partir desta área, você pode usar o sistema operacional de forma interativa.
2. Aqui está uma lista de processos nesta seção. A partir daqui, você pode facilmente ver quais processos infantis o malware que você executa tem.
3. Nesta área, há eventos de rede e arquivos.
4. Esta seção contém detalhes do processo.

Vamos examinar esses resultados.

Primeiro, vamos examinar os eventos do processo do malware na seção marcada "2" na imagem acima.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.11.38.png)

O malware que executamos manualmente parece ter criado dois processos infantis. Um deles é o **schtasks.exe**, que é executado para garantir a persistência no sistema criando uma tarefa de agendamento e o outro é o processo especificado como **"wareware AgentTesla"** pela AnyRun.

Quando clicamos em Processos, as informações sobre este processo são exibidas no número do painel 4. Vamos examinar os detalhes de todos os processos, respectivamente.

Uma vez que o processo chamado "WinRAR.exe" é criado quando extraímos o malware do arquivo para executá-lo, não examinaremos esse processo.

Quando clicamos no processo com ID **2680**, as informações sobre este processo são listadas no número **4**do painel 4.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.17.33.png)

Com o botão **"Mais informações"** neste painel, uma página com informações detalhadas sobre o processo é aberta. Quando queremos acessar informações detalhadas, podemos usar esta seção.

Quando as informações do processo com o 2680 ID são examinadas, o malware:

- Utiliza o Agendador de Tarefas,
- Escreve um programa para o sistema de arquivos que o tempo de compilação é muito antigo,
- Escreve muitos arquivos para o diretório de usuário

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.25.05.png)

Quando examinamos o processo com o ID **2616**, vemos que é **schtasks.exe** pertencente ao **Agendador de Tarefas**.

Quando examinamos os parâmetros da " **Linha de Comando",** vemos que ela cria uma tarefa de agendamento chamada " **Updates\neHneiobyhcrJJ**Updates?neeneiobyhcrJJ". As configurações para esta tarefa de agendamento estão no arquivo " **tmp5383.tmp".**

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.29.26.png)

Quando examinamos o arquivo de configuração de tarefa de agenda chamado **tmp5383.tmp**, vemos que o programa chamado " **neHneiobyhcrJ.exe"** será executado.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.32.53.png)

Quando examinamos o processo com ID **3140:**

- Este malware é reconhecido pelo AnyRun como **AgentTesla**,
- Roubar credenciais,
- Criação de ficheiros no directório do utilizador

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.36.06.png)

Quando examinamos as conexões de rede feitas a partir do número 3 do painel, vemos que o malware se conecta ao **smtp.godforeu.com**.

Com a ajuda do botão à direita do painel, podemos examinar os dados de entrada/descarga.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.39.10.png)

Quando as atividades de rede do malware são examinadas, descobrimos que o malware extraia dados com o protocolo SMTP.

Se você quiser examinar, você pode chegar à análise feita [aqui (Clique aqui](https://app.any.run/tasks/e4979ab7-3145-4121-a042-ea91d7e2c86b)).

---

# 29 Links para analisar Malware mais rápido
Nós constantemente passamos tempo analisando malware. Listamos 29 endereços que podem ser úteis para os membros **da equipe azul** usarem o tempo com mais eficiência:

- [Anlyz](https://sandbox.anlyz.io)
- [Any.run](https://app.any.run)
- [Comodo Valkyrie](https://valkyrie.comodo.com)
- [Cuckoo](https://sandbox.pikker.ee/)
- [Hybrid Analysis](http://www.hybrid-analysis.com/)
- [Intezer Analyze](https://www.intezer.com)
- [SecondWrite Malware Deepview](https://www.secondwrite.com)
- [Jevereg](http://jevereg.amnpardaz.com/)
- [IObit Cloud](http://cloud.iobit.com)
- [BinaryGuard](http://www.binaryguard.com)
- [BitBlaze](http://bitblaze.cs.berkeley.edu/)
- [SandDroid](http://sanddroid.xjtu.edu.cn)
- [Joe Sandbox](https://www.joesandbox.com/#windows)
- [AMAaaS](https://amaaas.com/)
- [IRIS-H](https://iris-h.services/pages/dashboard#/pages/dashboard)
- [Gatewatcher Intelligence](https://intelligence.gatewatcher.com/)
- [Hatching Triage](https://tria.ge/) 
- [InQuest Labs](https://labs.inquest.net/dfi)
- [Manalyzer](https://manalyzer.org/)
- [SandBlast Analysis](https://threatpoint.checkpoint.com/ThreatPortal/emulation)
- [SNDBOX](https://app.sndbox.com/)
- [firmware](http://firmware.re/)
- [opswat](https://metadefender.opswat.com/?lang=en)
- [virusade](http://virusade.com/)
- [virustotal](https://www.virustotal.com/gui/)
- [malware config](https://malwareconfig.com/)
- [malware hunter team](https://id-ransomware.malwarehunterteam.com/)
- [virscan](http://www.virscan.org) 
- [jotti](https://virusscan.jotti.org/it)